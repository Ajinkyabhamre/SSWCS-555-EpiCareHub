# EpiCareHub CircleCI Configuration
# This configuration runs tests for both Frontend and Backend
# Changes made:
# 1. Fixed backend job working_directory from ~/project/Frontend to ~/project/Backend
# 2. Updated package manager detection and usage
# 3. Removed --passWithNoTests flag to enforce actual test execution
# 4. Added proper npm install step with environment variables

version: 2.1
orbs:
  node: circleci/node@5
jobs:
  test-frontend:
    # Install dependencies and run frontend tests
    executor: node/default
    working_directory: ~/project/Frontend
    steps:
      - checkout:
          path: ~/project
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Run Frontend Tests
          command: npm test
      - store_test_results:
          path: coverage/

  test-backend:
    # Install dependencies and run backend tests
    executor: node/default
    working_directory: ~/project/Backend
    steps:
      - checkout:
          path: ~/project
      - run:
          name: Create .env file for tests
          command: |
            echo "MONGODB_URI=mongodb://localhost:27017/epicarehub-test" > .env
            echo "SESSION_SECRET=test-secret-key" >> .env
            echo "PYTHON_API_URL=http://localhost:8000" >> .env
            echo "PORT=3000" >> .env
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Run Backend Tests
          command: npm test
      - store_test_results:
          path: coverage/

workflows:
  build-and-test:
    jobs:
      - test-frontend
      - test-backend
    # Deployment job can be enabled when ready
    # - deploy:
    #     requires:
    #       - test-frontend
    #       - test-backend
    #     filters:
    #       branches:
    #         only: main
